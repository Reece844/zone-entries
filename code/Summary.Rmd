---
title: 'FROM GRAPES AND PRUNES TO APPLES AND APPLES: USING MATCHED METHODS TO ESTIMATE
  OPTIMAL ZONE ENTRY DECISION-MAKING IN THE NATIONAL HOCKEY LEAGUE'
author:
- affiliation: Columbia University
  affiliation_url: https://www.columbia.edu
  name: Asmae Toumi
- affiliation: NFL
  affiliation_url: https://www.nfl.com
  name: Michael Lopez
  url: https://statsbylopez.netlify.com
date: '2019-09-28'
output:
  distill::distill_article:
    toc: yes
  bookdown::word_document2: default 
  html_document:
    df_print: paged
    toc: yes
  bookdown::html_document2:
    theme: flatly
    toc: yes
    toc_float: yes
params:
  palette: berlin
---


```{r echo=TRUE, include=FALSE}
library("rmarkdown")
library("tidyverse") 
library("distill")
library("bookdown")
library("rticles")
library("janitor")
library("skimr") 
library("here")
library("scico") 
library("arsenal") 
library("cowplot") 
library("tableone") 
library("usethis")
library("revealjs")
library("BART")
library("Matching")
```



## Abstract 

Previous research in the National Hockey League has suggested that teams’ decisions to gain the offensive zone with puck possession (“carry-ins”) is preferred over dumping the puck in and chasing after it (“dump-ins”). However, standard comparisons of zone entry strategy are confounded by factors such as offensive and defensive talent, location on the ice, and shift time, each of which impact player choice. Indeed, contrasting carry-ins to dump-ins isn’t exactly an apples-to-apples comparison; instead, it is more like studying grapes versus prunes. Using two matching methods – propensity score matching and Bayesian additive regression trees – we leverage player-tracking data to estimate the causal benefits due to zone-entry decisions. Both approaches better account for the variables that affect entry choice. We also highlight the wide-ranging potential of the causal inference framework with player tracking data in sports while emphasizing the challenges of using standard statistical methods to inform decision-making in the presence of substantial confounding. 

## Introduction 

In hockey, players can enter the offensive zone by either carrying the puck in or dumping it. This decision is typically made by the player or their head coach. This decision is informed by, among other factors, offensive and defensive talent, location on the ice, shift time, time left in the game and score differential. 

Previous research done by Tulsky (2013) showed that:

> "A team that moves the puck through the neutral zone most effectively will be able to enter the offensive zone with possession, carrying the puck across the blue line. This might be expected to result in more shots and goals than a play where the team dumps the puck into the corner hoping to retrieve it. [...] Every data set collected showed entries with possession being more than twice as effective as dump-ins at 5-on- 5. The neutral zone play that sets a team up to enter the offensive zone with possession is a critical driver of success."
>

**ML: This paragraph sounds a bit like the abstract. That's fine, but maybe worth simplifying?**

The primary goal of this research is to estimate the potential benefit that teams can gain by carrying it in instead of dumping it. For this purpose, we accounted for several game and play characteristics that could affect a player's decision to carry it in or dumping it, a few of which stem from player tracking data. We use matched methods with finite population propensity scores to help account for other factors impacting carry-in vs dump-in decisions. We linked plays where a team dumped it in, defined as our control, to a play where a team carried it in, defined as our treatment. We used a sample of plays where, according to a logistic regression model, **teams should have carried it in**[ML: this is more a probability than a "should"]. Plays were matched based on: position of the entry player (Forward or defenseman), regularized Goals Plus-Minus per 60 minutes (GPM_60), length of shift, seconds left in the game and location of entry player. Within the matched cohort of plays, we estimated the observed change in expected goals per 30 seconds after each play. We also used a Bayesian nonparametric modeling procedure, Bayesian Additive Regression Trees (BART), to estimate the same observed change. Among many advantages, BART allowed for the identification of heterogeneous treatment effects.



## The fundamental problem of causal inference 

If the player knew the outcome of both zone entry strategies, deciding whether to carry the puck in or dump it would be a no-brainer**ML edits**. This is not possible, as we only know the outcome of *one* of the strategies, the one that the player chose.  This is the problem that causal inference attempts to solve. Causal inference deals with prediciting the outcomes for the other strategy that was not undertaken. It also mimics some of the advantages of a randomized experiment when randomization is difficult or impossible to implement, like it is in hockey. 

## Propensity score matching and BART 

**ML**: Let's start by defining the ATT: that is, what are we trying to estimate?  Then, say we have two approaches for estimating the ATT.

We use matched methods with finite population propensity scores (Imbens and Rubin, 2015) to help account for all the variables that could impact a player's decision to carry the puck in or dump it. Propensity score, first introduced in 1983, corresponds to the probability of receiving a treatment given the observed variables (Rosenbaum and Rubin, 1983). The propensity score is used for flexible matching of treatment and control groups with similar distribution of variables. Grouping individuals with similar propensity scores **works to** replicates a randomized experiment (Stuart, 2010). 

Another method used to estimate causal effects are Bayesian Additive Regression Trees (BART). BART is a Bayesian nonparametric modeling procedure that is used to fit the response surface model. Compared to propensity score matching, BART generates posterior intervals. Additionally, treatment effect estimates using BART have been shown to be signficiantly more accurate than propensity score matching (Hill, 2012). It is also believed to be the more superior approach when there are many confounding covariates as is the case in many causal inference problems. Finally, BART also has the advantage of readily identifying heterogeneous treatment effects which is of special interest to us. 



## Data 

We obtained zone-entry tracking data from Stathletes for the 2017-18 and 2018-19 NHL seasons. We matched only within even-strength situations, leaving `n = 277,661` entries, of which `n = 158,808` carry-ins and `n = 118,853` dump-ins. We obtained Goals Plus-Minus per 60 minutes (`GPM_60`) from Evolving-Hockey <https://evolving-hockey.com> to account for player skill. From <Evolving-Hockey>[https://evolving-hockey.com], we also obtained expected goals (`xG`) and calculated xG as a function of time using NHL play-by-play data.



## Propensity score model

Our propensity score model estimates the probability of a player carrying the puck in given game characteristics of each carry-in, called $e(X)$. We used a multiple logistic regression model with spline terms to estimate the covariates defined in Table 1. The ultimate goal of estimating $e(X)$ is to balance the variables in X between the players that carried it in and the players that did not. The full list of interaction terms and spline knots used in the propensity score model can be found in Table 2. Note: the list of interaction terms were chosen using our understanding of what influences zone entry decision-making. The spline knots were chosen as to obtain the lowest Akaike information criterion (AIC). 

**Table 1: Descriptions of variables and interaction terms used in the propensity score model**

| Variable          | Description                                     | Spline knots |
|:------------------|:-----------------------------------------------:|--------------:
| Position          | position of entry player, forward or defenseman | NA           |         
| score_diff        | score differential                              | NA           |
| length_of_shift   | shift length for entry player                   | 10           |
| game_seconds      | seconds left in the game                        | 5            |
| x_entry           | x-coordinate of entry player                    | 5            |
| y_entry           | y-coordinate of entry player                    | 5            |
| GPM_60            | Goals plus-minus per 60 minutes                 | 5            |
| GPM_60*score_diff | interaction term                                | 5 & NA       |
| x_entry*y_entry   | interaction term                                | 5 & 5        |


## Matching

Our initial data contained `n = 15,8808` carry-ins, `n = 11,8853` dump-ins**ML: drop this sentence, as it's repetitive]**. Using the `Matching` package, we performed one-to-one matching with replacement using the estimated propensity score. Our matching cohort consisted of `n = 153,498` matched pairs. Each pair includes one play where a team did *not* carry it in, as well as a corresponding match where a different player did carry it in. Matching success across all plays in the matched cohort is best measured by comparing the distributions of X between players that carried it in and players that did not, for example: 


```{r density, echo=FALSE, out.width = '150%'}
knitr::include_graphics('/Users/atoumi/Dropbox (Personal)/zone-entries-nhl/figs/p4.png')

```




## Results

In our experiment, the "treated" are the players who carried the puck in and the control are those that dumped it in. We compare the treated and control groups that are as similar as possible. Our estimand of interest is the average effect of the treatment on the treated (ATT). ATT reflects the expected causal effect of carry-ins among players who did carry it in. In other words, it approximates the value of carry it in among those who had the chance to do so.  

With our propensity score model, the estimated ATT was `0.0209`. The following tables show that the four outcomes considered were similar among the the matched cohort and the overall group:

**ML: I'd drop the before matching table. Without really accounting for all that goes into zone entries (e.g., spatial data), we just don't have enough confounding accounted for**

Before matching,  

| Type          | Avg. xG for per 30s | Avg. xG against per 30s  | Avg. Shots on Goal per 30s  | Number of plays
|:--------------|:--------------------|:--------------------------|:---------------------------|:---------------
| Carried       | 0.0270              | 0.0127                    | 0.349                      | 158808
| Dumped        | 0.00616             | 0.0128                    | 0.910                      | 118853

**ML: I'd show ATTs here instead of the averages. ATTs are just the differences between the two (e.g, 0.0272 - 0.00624). It's probably worth writing that the standard errors are tiny given the sample sizes**

After matching, 

| Type          | Avg. xG for per 30s | Avg. xG against per 30s  | Avg. Shots on Goal per 30s | Number of plays
|:--------------|:--------------------|:-------------------------|:---------------------------|:---------------
| Carried       | 0.0272              | 0.0127                   | 0.349                      | 153498
| Dumped        | 0.00624             | 0.0127                   | 0.0925                     | 153498

**ML: we'll want to say exactly what 0.0272 - 0.00624 = 0.02096 is. In this in this instance, it's the difference in net xGs in the next 30 seconds for an entry that was a carry-in and not a dump-in. Roughly, 1 extra goal every 50 carry-ins. That seems small, but there are about 30 cary-ins per game per team (153498/(1230*2*2), where 1230 is the number of games in a season. So, those will add up. Additionally, it's not like xGs against are any worse after the carry-in.**

Compared to propensity score matching, BART algorithm yielded a similar ATT estimate of `0.0205`. BART is able to identify heterogenous trerament effects across different groups. In other words, BART allows us to estimate the benefit of carrying it in for each variable. Comparing defensemen to forwards, we see that in the table below, it is approximately 50% **[ML: it's 23 percent after running on the full sample]** more beneficial for a forward to carry it in: 

|               | Avg. ATT | Std Error | 
|:--------------|:---------|:----------|
| Forward       | 0.0211   | 0.0000134 |
| Defenseman    | 0.0171   | 0.0000296 | 

Surprisingly, there appears to be no association between Goals plus-minus per 60 minutes and position of entry player since the conditional average treatment effect on the treated (CATT) are stable:

```{r echo=FALSE, fig.cap="Conditional Average Treatment effect on the Treated (CATT) for entry player's position. The solid lines represent the true treatment effect as it varies with X. The dotted lines represent the marginal 95% posterior intervals for the treatment effect at each X value from a treated observation.", out.width = '100%'}
knitr::include_graphics('/Users/atoumi/Dropbox (Personal)/zone-entries-nhl/figs/CATT_pos.png')

```


The conditional average treatment effects (CATT's) for all the other variables is shown in the figure below. 

**ml: I'm not sure I honestly trust our data to say it's surprising. We aren't saying they are equally good once they carry it in. We are just saying that the difference between carrying it in and dumping it is the same for players of different talents. In some ways perhaps this means that players are already playing to some ideal level. If it was better for one group (good or bad players) to do this more than the other group, it'd mean that there was some type of inefficiency. That doesn't appear to be the case.**

**ML: I'd drop this plot altogether, and just write that there were no noticeable difference between causal estimates by score, time on clock, or shift length**


We see that the marginal 95% posterior intervals -- represented by the dotted lines -- cover the true CATT's well for all variables save for the zone entry x-coordinates. A surprising and unexpected result is the stability of GPM_60 when one would expect an improvement in estimated ATT of carry-ins with higher GPM_60. Of note, the uncertainty bounds are very wide for x-entry coordinates below 100 feet. This corresponds to a range where there is no overlap across treatment groups. 

```{r echo=FALSE, fig.cap="Conditional Average Treatment effect on the Treated (CATT) for different covariates. The solid lines represent the true treatment effect as it varies with X. The dotted lines represent the marginal 95% posterior intervals for the treatment effect at each X value from a treated observation.", out.width='100%'}
knitr::include_graphics('/Users/atoumi/Dropbox (Personal)/zone-entries-nhl/figs/CATT_covs_init.png')
```


This is reflected in the spatial plot below, where entries below 100-125 feet were relatively less frequent than others. 

**ML: love this. The only tweak I'd make is that the blue line looks like the blue estimate that corresponds to negative ATTs. I can suggest some color schemes, but ideally err away from blue and red if possible?**

```{r echo=FALSE, fig.cap="Spatial plot. Code for NHL half rink borrowed from <https://gitlab.com/mtthwastn/statswithmatt/tree/master/hockey-with-r>", out.width = '100%'}
knitr::include_graphics('/Users/atoumi/Dropbox (Personal)/zone-entries-nhl/figs/spatial_plot.png')

```

Filtering for more realistic score differential and zone entry x-coordinates where overlap exists:

```{r echo=FALSE, fig.cap="Conditional Average Treatment effect on the Treated (CATT) for different covariates. The solid lines represent the true treatment effect as it varies with X. The dotted lines represent the marginal 95% posterior intervals for the treatment effect at each X value from a treated observation.", out.width = '100%'}
knitr::include_graphics('/Users/atoumi/Dropbox (Personal)/zone-entries-nhl/figs/CATT_covs.png')
```

We note the important improvement in the ATT of carry-ins with y-coordinates over 60 feet. It appears that zone entries attempted near center ice are better than the ones attempted near the boards. 

## Limitations

**ML: Worth a sentence or two about the variables we don't have -- primarily, where on the ice each player was**

## Code and data

Although we cannot share the tracking data, our entire analysis plan is available on Github in a public repository **INSERT LINK WHEN READY**. This includes publicly available data like the NHL pbp and Evolving-Hockey data as well as code for each of:

- Data wrangling
- Our matching algorithm 
- Analysis
- Results

Please consult ............................................................ for the code, data and figures.

## Acknowledgments {.appendix}

Our thanks to Meghan Chayka, Neil Lane and the entire team of Stathletes for their tracking data and guidance. Thanks to Evolving-Hockey for providing NHL play-by-play data and their Goals Plus-Minus metric through their website: www.evolving-hockey.com.